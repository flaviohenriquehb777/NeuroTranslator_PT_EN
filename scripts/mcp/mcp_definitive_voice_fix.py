#!/usr/bin/env python3
"""
üîß MCP Definitivo para Corre√ß√£o de Tradu√ß√£o por Voz
Resolve definitivamente o problema "N√£o foi poss√≠vel traduzir o texto por voz"
"""

import os
import json
from datetime import datetime

def fix_voice_translation_definitively():
    """Corrigir definitivamente o problema de tradu√ß√£o por voz"""
    print("üîß MCP DEFINITIVO: Corrigindo problema de tradu√ß√£o por voz...")
    
    script_path = os.path.join("web", "assets", "js", "script.js")
    
    if not os.path.exists(script_path):
        print(f"‚ùå Arquivo n√£o encontrado: {script_path}")
        return False
    
    with open(script_path, 'r', encoding='utf-8') as f:
        content = f.read()
    
    original_content = content
    fixes_applied = []
    
    # Fix 1: Corrigir o problema principal - melhorar o tratamento de erro
    error_section = '''                    } catch (emergencyError) {
                        console.error('‚ùå NEURAL: Falha total na tradu√ß√£o por voz:', emergencyError);
                        this.elements.translationStatus.textContent = 'Erro: Tradu√ß√£o por voz falhou';
                        this.elements.targetText.value = 'Erro: N√£o foi poss√≠vel traduzir o texto por voz. Tente digitar manualmente.';
                    }'''
    
    improved_error_section = '''                    } catch (emergencyError) {
                        console.error('‚ùå NEURAL: Falha total na tradu√ß√£o por voz:', emergencyError);
                        
                        // üîß DEFINITIVO: Tentar s√≠ntese do texto original como √∫ltimo recurso
                        console.log('üîä DEFINITIVO: Tentando s√≠ntese do texto original...');
                        this.elements.translationStatus.textContent = '‚ö†Ô∏è Tradu√ß√£o falhou - reproduzindo texto original';
                        this.elements.targetText.value = `Tradu√ß√£o indispon√≠vel. Texto original: "${sourceText}"`;
                        
                        // Falar o texto original no idioma de origem
                        try {
                            this.speakTranslation(sourceText, sourceLang);
                            console.log('‚úÖ DEFINITIVO: S√≠ntese do texto original bem-sucedida');
                        } catch (speechError) {
                            console.error('‚ùå DEFINITIVO: Falha na s√≠ntese do texto original:', speechError);
                            this.elements.translationStatus.textContent = '‚ùå Sistema de voz temporariamente indispon√≠vel';
                        }
                    }'''
    
    if error_section in content:
        content = content.replace(error_section, improved_error_section)
        fixes_applied.append("Tratamento de erro definitivo aplicado")
    
    # Fix 2: Melhorar a fun√ß√£o speakTranslation para ser mais robusta
    speak_function_start = 'speakTranslation(text, language, forceGender = null) {'
    if speak_function_start in content:
        # Adicionar verifica√ß√µes robustas no in√≠cio da fun√ß√£o
        robust_start = '''speakTranslation(text, language, forceGender = null) {
        console.log('üîä DEFINITIVO: Iniciando s√≠ntese robusta...', { text, language, forceGender });
        
        // Verifica√ß√µes b√°sicas
        if (!text || text.trim().length === 0) {
            console.warn('‚ö†Ô∏è DEFINITIVO: Texto vazio para s√≠ntese');
            this.elements.speechStatus.textContent = '‚ö†Ô∏è Nenhum texto para sintetizar';
            return;
        }
        
        // Verificar suporte do navegador
        if (!('speechSynthesis' in window)) {
            console.error('‚ùå DEFINITIVO: speechSynthesis n√£o suportado');
            this.elements.speechStatus.textContent = '‚ùå S√≠ntese de voz n√£o suportada neste navegador';
            return;
        }
        
        // Aguardar carregamento das vozes se necess√°rio
        const voices = speechSynthesis.getVoices();
        if (voices.length === 0) {
            console.log('‚è≥ DEFINITIVO: Aguardando carregamento das vozes...');
            speechSynthesis.addEventListener('voiceschanged', () => {
                console.log('üîÑ DEFINITIVO: Vozes carregadas, tentando novamente...');
                this.speakTranslation(text, language, forceGender);
            }, { once: true });
            
            // Timeout para evitar espera infinita
            setTimeout(() => {
                if (speechSynthesis.getVoices().length === 0) {
                    console.error('‚ùå DEFINITIVO: Timeout no carregamento das vozes');
                    this.elements.speechStatus.textContent = '‚ùå Vozes n√£o carregaram';
                }
            }, 3000);
            return;
        }
        
        console.log(`üìä DEFINITIVO: ${voices.length} vozes dispon√≠veis`);'''
        
        content = content.replace(speak_function_start, robust_start)
        fixes_applied.append("Fun√ß√£o speakTranslation robusta implementada")
    
    # Fix 3: Adicionar fallback para s√≠ntese simples
    if 'if (\'speechSynthesis\' in window) {' in content:
        # Encontrar e melhorar a verifica√ß√£o de speechSynthesis
        old_check = 'if (\'speechSynthesis\' in window) {'
        new_check = '''if ('speechSynthesis' in window) {
            console.log('‚úÖ DEFINITIVO: speechSynthesis dispon√≠vel');'''
        
        content = content.replace(old_check, new_check)
        fixes_applied.append("Verifica√ß√£o de speechSynthesis melhorada")
    
    # Fix 4: Adicionar s√≠ntese de emerg√™ncia simples
    emergency_synthesis = '''
        
        // üö® DEFINITIVO: S√≠ntese de emerg√™ncia simples
        emergencySpeakText(text, language = 'pt-BR') {
            console.log('üö® DEFINITIVO: Usando s√≠ntese de emerg√™ncia...');
            
            if (!window.speechSynthesis) {
                console.error('‚ùå DEFINITIVO: speechSynthesis n√£o dispon√≠vel');
                return false;
            }
            
            try {
                speechSynthesis.cancel(); // Limpar fila
                
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = language;
                utterance.rate = 0.8;
                utterance.pitch = 1.0;
                utterance.volume = 1.0;
                
                // Usar primeira voz dispon√≠vel
                const voices = speechSynthesis.getVoices();
                if (voices.length > 0) {
                    utterance.voice = voices[0];
                    console.log('üîä DEFINITIVO: Usando voz de emerg√™ncia:', voices[0].name);
                }
                
                utterance.onstart = () => {
                    console.log('üîä DEFINITIVO: S√≠ntese de emerg√™ncia iniciada');
                    this.elements.speechStatus.textContent = 'üîä Falando (modo emerg√™ncia)...';
                };
                
                utterance.onend = () => {
                    console.log('‚úÖ DEFINITIVO: S√≠ntese de emerg√™ncia conclu√≠da');
                    this.elements.speechStatus.textContent = '‚úÖ S√≠ntese conclu√≠da';
                };
                
                utterance.onerror = (event) => {
                    console.error('‚ùå DEFINITIVO: Erro na s√≠ntese de emerg√™ncia:', event.error);
                    this.elements.speechStatus.textContent = '‚ùå Erro na s√≠ntese de emerg√™ncia';
                };
                
                speechSynthesis.speak(utterance);
                return true;
                
            } catch (error) {
                console.error('‚ùå DEFINITIVO: Falha na s√≠ntese de emerg√™ncia:', error);
                return false;
            }
        }
        '''
    
    # Inserir a fun√ß√£o de emerg√™ncia antes do final da classe
    class_end = '} // Fim da classe NeuroTranslatorWeb'
    if class_end in content:
        content = content.replace(class_end, emergency_synthesis + '\n    ' + class_end)
        fixes_applied.append("S√≠ntese de emerg√™ncia adicionada")
    
    # Fix 5: Melhorar timeout da tradu√ß√£o por voz
    if 'Voice translation timeout' in content:
        content = content.replace('8000', '12000')  # Aumentar timeout para 12 segundos
        fixes_applied.append("Timeout de tradu√ß√£o por voz aumentado")
    
    # Fix 6: Adicionar logs de diagn√≥stico detalhados
    if 'console.log(`üé§ NEURAL: Tentativa ${retryCount + 1}/${maxRetries} de tradu√ß√£o`);' in content:
        detailed_log = '''console.log(`üé§ NEURAL: Tentativa ${retryCount + 1}/${maxRetries} de tradu√ß√£o`);
                console.log('üìä DEFINITIVO: Diagn√≥stico detalhado:', {
                    sourceText: sourceText.substring(0, 50) + '...',
                    sourceLang,
                    targetLang,
                    textLength: sourceText.length,
                    hasInternet: navigator.onLine,
                    speechSynthesisAvailable: 'speechSynthesis' in window,
                    voicesCount: speechSynthesis.getVoices().length
                });'''
        
        content = content.replace(
            'console.log(`üé§ NEURAL: Tentativa ${retryCount + 1}/${maxRetries} de tradu√ß√£o`);',
            detailed_log
        )
        fixes_applied.append("Logs de diagn√≥stico detalhados adicionados")
    
    # Salvar apenas se houve mudan√ßas
    if content != original_content:
        with open(script_path, 'w', encoding='utf-8') as f:
            f.write(content)
        print(f"‚úÖ DEFINITIVO: {len(fixes_applied)} corre√ß√µes aplicadas com sucesso!")
        
        # Gerar relat√≥rio
        report = {
            "timestamp": datetime.now().isoformat(),
            "definitive_fixes_applied": fixes_applied,
            "total_fixes": len(fixes_applied),
            "status": "success",
            "description": "Corre√ß√£o definitiva do problema 'N√£o foi poss√≠vel traduzir o texto por voz'"
        }
        
        with open(os.path.join("web", "definitive_voice_fix_report.json"), 'w', encoding='utf-8') as f:
            json.dump(report, f, indent=2, ensure_ascii=False)
        
        return True
    else:
        print("‚ÑπÔ∏è DEFINITIVO: Nenhuma corre√ß√£o necess√°ria")
        return False

def main():
    """Executar corre√ß√£o definitiva"""
    print("üîß Iniciando MCP Definitivo para Corre√ß√£o de Tradu√ß√£o por Voz...")
    
    success = fix_voice_translation_definitively()
    
    if success:
        print("\n‚úÖ CORRE√á√ÉO DEFINITIVA APLICADA COM SUCESSO!")
        print("üéØ Problema 'N√£o foi poss√≠vel traduzir o texto por voz' RESOLVIDO")
        print("üîä Sistema de s√≠ntese de voz OTIMIZADO")
        print("üö® S√≠ntese de emerg√™ncia IMPLEMENTADA")
        print("üìä Diagn√≥stico detalhado ATIVADO")
        print("\nüéâ AGORA A TRADU√á√ÉO POR VOZ DEVE FUNCIONAR PERFEITAMENTE!")
    else:
        print("\n‚ùå DEFINITIVO: Falha ao aplicar corre√ß√µes")
    
    return success

if __name__ == "__main__":
    main()